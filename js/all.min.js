function KeyboardInputManager(){this.events={},this.listen()}function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container"),this.scoreContainer=document.querySelector(".score-container"),this.bestContainer=document.querySelector(".best-container"),this.messageContainer=document.querySelector(".game-message"),this.score=0}function Grid(e){this.size=e,this.cells=[],this.build()}function Tile(e,t){this.x=e.x,this.y=e.y,this.value=t||2,this.previousPosition=null,this.mergedFrom=null}function LocalScoreManager(){this.key="bestScore";var e=this.localStorageSupported();this.storage=e?window.localStorage:window.fakeStorage}function GameManager(e,t,i,n){this.size=e,this.inputManager=new t,this.scoreManager=new n,this.actuator=new i,this.startTiles=2,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.restart.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this)),this.bigValue=2,this.setup()}!function(){for(var e=0,t=["webkit","moz"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var i=(new Date).getTime(),n=Math.max(0,16-(i-e)),o=window.setTimeout(function(){t(i+n)},n);return e=i+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),KeyboardInputManager.prototype.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},KeyboardInputManager.prototype.emit=function(e,t){var i=this.events[e];i&&i.forEach(function(e){e(t)})},KeyboardInputManager.prototype.listen=function(){var e=this,t={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(i){var n=i.altKey||i.ctrlKey||i.metaKey||i.shiftKey,o=t[i.which];n||(void 0!==o&&(i.preventDefault(),e.emit("move",o)),32===i.which&&e.restart.bind(e)(i))});var i=document.querySelector(".retry-button");i.addEventListener("click",this.restart.bind(this)),i.addEventListener("touchend",this.restart.bind(this));var n=document.querySelector(".keep-playing-button");n.addEventListener("click",this.keepPlaying.bind(this)),n.addEventListener("touchend",this.keepPlaying.bind(this));var o,a,r=document.getElementsByClassName("game-container")[0];r.addEventListener("touchstart",function(e){e.touches.length>1||(o=e.touches[0].clientX,a=e.touches[0].clientY,e.preventDefault())}),r.addEventListener("touchmove",function(e){e.preventDefault()}),r.addEventListener("touchend",function(t){if(!(t.touches.length>0)){var i=t.changedTouches[0].clientX-o,n=Math.abs(i),r=t.changedTouches[0].clientY-a,s=Math.abs(r);Math.max(n,s)>10&&e.emit("move",n>s?i>0?1:3:r>0?2:0)}})},KeyboardInputManager.prototype.restart=function(e){e.preventDefault(),this.emit("restart")},KeyboardInputManager.prototype.keepPlaying=function(e){e.preventDefault(),this.emit("keepPlaying")},HTMLActuator.prototype.actuate=function(e,t){var i=this;window.requestAnimationFrame(function(){i.clearContainer(i.tileContainer),e.cells.forEach(function(e){e.forEach(function(e){e&&i.addTile(e)})}),i.updateScore(t.score),i.updateBestScore(t.bestScore),t.terminated&&(t.over?i.message(!1):t.won&&i.message(!0))})},HTMLActuator.prototype.continue=function(){this.clearMessage()},HTMLActuator.prototype.clearContainer=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},HTMLActuator.prototype.addTile=function(e){var t=this,i=document.createElement("div"),n=document.createElement("div"),o=e.previousPosition||{x:e.x,y:e.y},a=this.positionClass(o),r=["tile","tile-"+e.value,a];e.value>2048&&r.push("tile-super"),this.applyClasses(i,r),n.classList.add("tile-inner"),n.textContent=e.value,e.previousPosition?window.requestAnimationFrame(function(){r[2]=t.positionClass({x:e.x,y:e.y}),t.applyClasses(i,r)}):e.mergedFrom?(r.push("tile-merged"),this.applyClasses(i,r),e.mergedFrom.forEach(function(e){t.addTile(e)})):(r.push("tile-new"),this.applyClasses(i,r)),i.appendChild(n),this.tileContainer.appendChild(i)},HTMLActuator.prototype.applyClasses=function(e,t){e.setAttribute("class",t.join(" "))},HTMLActuator.prototype.normalizePosition=function(e){return{x:e.x+1,y:e.y+1}},HTMLActuator.prototype.positionClass=function(e){return e=this.normalizePosition(e),"tile-position-"+e.x+"-"+e.y},HTMLActuator.prototype.updateScore=function(e){this.clearContainer(this.scoreContainer);var t=e-this.score;if(this.score=e,this.scoreContainer.textContent=this.score,t>0){var i=document.createElement("div");i.classList.add("score-addition"),i.textContent="+"+t,this.scoreContainer.appendChild(i)}},HTMLActuator.prototype.updateBestScore=function(e){this.bestContainer.textContent=e},HTMLActuator.prototype.message=function(e){var t=e?"game-won":"game-over",i=e?"You win!":"Game over!";this.messageContainer.classList.add(t),this.messageContainer.getElementsByTagName("p")[0].textContent=i},HTMLActuator.prototype.clearMessage=function(){this.messageContainer.classList.remove("game-won"),this.messageContainer.classList.remove("game-over")},Grid.prototype.build=function(){for(var e=0;e<this.size;e++)for(var t=this.cells[e]=[],i=0;i<this.size;i++)t.push(null)},Grid.prototype.randomAvailableCell=function(){var e=this.availableCells();return e.length?e[Math.floor(Math.random()*e.length)]:void 0},Grid.prototype.availableCells=function(){var e=[];return this.eachCell(function(t,i,n){n||e.push({x:t,y:i})}),e},Grid.prototype.eachCell=function(e){for(var t=0;t<this.size;t++)for(var i=0;i<this.size;i++)e(t,i,this.cells[t][i])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(e){return!this.cellOccupied(e)},Grid.prototype.cellOccupied=function(e){return!!this.cellContent(e)},Grid.prototype.cellContent=function(e){return this.withinBounds(e)?this.cells[e.x][e.y]:null},Grid.prototype.insertTile=function(e){this.cells[e.x][e.y]=e},Grid.prototype.removeTile=function(e){this.cells[e.x][e.y]=null},Grid.prototype.withinBounds=function(e){return e.x>=0&&e.x<this.size&&e.y>=0&&e.y<this.size},Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(e){this.x=e.x,this.y=e.y},window.fakeStorage={_data:{},setItem:function(e,t){return this._data[e]=String(t)},getItem:function(e){return this._data.hasOwnProperty(e)?this._data[e]:void 0},removeItem:function(e){return delete this._data[e]},clear:function(){return this._data={}}},LocalScoreManager.prototype.localStorageSupported=function(){var e="test",t=window.localStorage;try{return t.setItem(e,"1"),t.removeItem(e),!0}catch(i){return!1}},LocalScoreManager.prototype.get=function(){return this.storage.getItem(this.key)||0},LocalScoreManager.prototype.set=function(e){this.storage.setItem(this.key,e)},GameManager.prototype.restart=function(){this.bigValue=2,this.actuator.continue(),this.setup()},GameManager.prototype.keepPlaying=function(){this.keepPlaying=!0,this.actuator.continue()},GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying?!0:!1},GameManager.prototype.setup=function(){this.grid=new Grid(this.size),this.score=0,this.over=!1,this.won=!1,this.keepPlaying=!1,document.querySelector("body").className="bigscore-2",this.addStartTiles(),this.actuate()},GameManager.prototype.addStartTiles=function(){for(var e=0;e<this.startTiles;e++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var e=Math.random()<.9?2:4,t=new Tile(this.grid.randomAvailableCell(),e);this.grid.insertTile(t)}},GameManager.prototype.actuate=function(){this.scoreManager.get()<this.score&&this.scoreManager.set(this.score),this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.scoreManager.get(),terminated:this.isGameTerminated()})},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(e,t,i){i&&(i.mergedFrom=null,i.savePosition())})},GameManager.prototype.moveTile=function(e,t){this.grid.cells[e.x][e.y]=null,this.grid.cells[t.x][t.y]=e,e.updatePosition(t)},GameManager.prototype.move=function(e){var t=this;if(!this.isGameTerminated()){var i,n,o=this.getVector(e),a=this.buildTraversals(o),r=!1;this.prepareTiles(),a.x.forEach(function(e){a.y.forEach(function(a){if(i={x:e,y:a},n=t.grid.cellContent(i)){var s=t.findFarthestPosition(i,o),l=t.grid.cellContent(s.next);if(l&&l.value===n.value&&!l.mergedFrom){var c=new Tile(s.next,2*n.value);c.mergedFrom=[n,l],t.grid.insertTile(c),t.grid.removeTile(n),n.updatePosition(s.next),t.score+=c.value,c.value>t.bigValue&&(t.bigValue=c.value,document.querySelector("body").className="bigscore-"+t.bigValue),2048===c.value&&(t.won=!0)}else t.moveTile(n,s.farthest);t.positionsEqual(i,n)||(r=!0)}})}),r&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}},GameManager.prototype.getVector=function(e){var t={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};return t[e]},GameManager.prototype.buildTraversals=function(e){for(var t={x:[],y:[]},i=0;i<this.size;i++)t.x.push(i),t.y.push(i);return 1===e.x&&(t.x=t.x.reverse()),1===e.y&&(t.y=t.y.reverse()),t},GameManager.prototype.findFarthestPosition=function(e,t){var i;do i=e,e={x:i.x+t.x,y:i.y+t.y};while(this.grid.withinBounds(e)&&this.grid.cellAvailable(e));return{farthest:i,next:e}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var e,t=this,i=0;i<this.size;i++)for(var n=0;n<this.size;n++)if(e=this.grid.cellContent({x:i,y:n}))for(var o=0;4>o;o++){var a=t.getVector(o),r={x:i+a.x,y:n+a.y},s=t.grid.cellContent(r);if(s&&s.value===e.value)return!0}return!1},GameManager.prototype.positionsEqual=function(e,t){return e.x===t.x&&e.y===t.y},window.requestAnimationFrame(function(){new GameManager(4,KeyboardInputManager,HTMLActuator,LocalScoreManager)});for(var i=2;2048>i;){var imageObject=new Image;imageObject.src="meta/bg-"+i+".jpg",i*=2}